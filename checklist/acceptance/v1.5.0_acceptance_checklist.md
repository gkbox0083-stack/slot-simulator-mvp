# v1.5.0 Acceptance Checklist (Pay Rule Engine Grounding)

> **Project:** Slot Math IDE – slot-simulator-mvp  
> **Version:** v1.5.0 (Pay Rule Engine foundation)  
> **Goal:** Verify v1.5.0 is **correct, deterministic, and backwards compatible** before entering Branch A (Invariant/Regression).  
> **Definition of Done:** All **P0** items pass.

---

## How to run (recommended baseline)

### Commands
- **Console report (quick):**
  - `node logic/cli.js -n 1000`
- **CSV export (required for shadow fields):**
  - `node logic/cli.js -n 10000 --csv`
- (Optional) **No visual** if supported:
  - `node logic/cli.js -n 10000 --csv --no-visual`

### Evidence to keep
- The generated `result.csv`
- The console log for the run
- Git commit hash of the tested build

---

## P0 – Must Pass (Blockers)

### P0-1. Simulation completes (no crash)
- [ ] Running `node logic/cli.js -n 1000 --csv` completes successfully.
- [ ] No `Validation mismatch` exceptions.
- [ ] No uncaught exceptions / stack traces.

**Pass evidence:** console log ends normally and CSV is produced.

---

### P0-2. Single Evaluation Point is enforced
- [ ] `PayRuleEvaluator.evaluate()` is called **only** from `logic/simulate.js` (not from resolver / visualConstraint / reporter / cli).
- [ ] `visualConstraint.js` does **NOT** import or call the evaluator.

**How to check:**
- [ ] Project-wide search for `.evaluate(` shows only the intended call site(s) in `simulate.js`.

---

### P0-3. Truth Source + Strict Validation are active
- [ ] `validateStrict(outcome, bet, winEvents)` runs for **every spin** that produces a valid grid (BASE and FREE if FREE is enabled).
- [ ] When `outcome.payoutMultiplier * bet > 0`, evaluator must produce events whose total winAmount matches expected exactly.
- [ ] Comparison uses **integer credits** (no float drift).

**Pass evidence:** CSV shows `evaluationMatch=true` for all payout>0 spins (or 100% within the validated scope).

---

### P0-4. WinEvent shape is stable and v1.5.0-constrained
- [ ] `winEvents` is always an array (never null/undefined).
- [ ] v1.5.0 constraint holds: `winEvents.length <= 1`.
- [ ] For LINE wins, the single event contains:
  - [ ] `ruleType === "LINE"`
  - [ ] `winAmount` is integer credits
  - [ ] `paylineIndex` present
  - [ ] `positions` present and uses **[row, col]** coordinates
- [ ] No `WILD` substitution behavior exists in v1.5.0.

**Pass evidence:** sample rows in `eventsJson` show correct fields.

---

### P0-5. Visual Layer uses winEvents.positions first (G3)
- [ ] `visualConstraint.applyConstraints(...)` accepts `winEvents` (new param) and legacy `winLine` (fallback).
- [ ] Protected cells derivation priority is:
  1. [ ] `winEvents[0].positions` (if present)
  2. [ ] legacy `winLine` + expected matchCount (fallback)
  3. [ ] empty set (LOSS)
- [ ] Visual layer does **NOT** scan grid to “discover” winning cells.
- [ ] If visual changes violate protected cells, it falls back safely (and does not alter math outcomes).

**Pass evidence:** log messages may show fallback, but validation still passes and results remain consistent.

---

### P0-6. Resolver remains outcome-driven; evaluator does not change RNG/outcome selection
- [ ] Outcome selection logic and weighted tables are unchanged.
- [ ] RNG class and weightedSelect behavior are untouched.
- [ ] Resolver still generates grids according to outcome intent (v1.4 behavior retained).

**How to check:**
- [ ] Diff review: no changes to RNG / weightedSelect / outcome tables logic.
- [ ] Same seed produces same outcomeId sequence (see P0-7).

---

### P0-7. Determinism regression: same seed => same outcomes + same RTP
- [ ] With the same seed/config, rerunning the simulation yields:
  - [ ] identical outcomeId sequence (at least for a short run, e.g., first 200 spins)
  - [ ] identical total win / RTP (within exact equality if fully deterministic)
- [ ] Visual RNG remains isolated (visual changes do not affect outcome selection).

**Pass evidence:** two CSV runs match on key columns for the compared window.

---

### P0-8. CSV Shadow Mode columns exist and are correct
Verify `result.csv` includes **all** required shadow fields:
- [ ] `expectedWinAmount`
- [ ] `evaluatedWinAmount`
- [ ] `evaluationMatch`
- [ ] `evaluatedEventCount`
- [ ] `evaluatedRuleTypes`
- [ ] `eventsJson`

And semantics:
- [ ] `expectedWinAmount` equals `outcome.payoutMultiplier * bet`
- [ ] `evaluatedWinAmount` equals sum(winEvents.winAmount)
- [ ] `evaluatedEventCount` equals `winEvents.length`
- [ ] `evaluatedRuleTypes` reflects event ruleType(s)
- [ ] `eventsJson` is valid JSON string

---

## P1 – Should Pass (Strongly Recommended)

### P1-1. Free Game parity (if FREE is enabled in v1.5.0)
- [ ] FREE spins generate real grids (not `[]`).
- [ ] FREE wins also satisfy `evaluationMatch=true`.
- [ ] Base vs Free RTP can be computed separately without crashes.

---

### P1-2. Visual fallback is not excessive (sanity)
- [ ] VisualConstraint fallback logs do not occur for the majority of winning spins.
- [ ] If fallback rate is high, record it as a known issue but do not change math.

---

### P1-3. Telemetry retains legacy columns
- [ ] Existing telemetry/CSV legacy fields still exist:
  - [ ] `outcomeId`, `winAmount`, `state`, indices (spinIndex/baseSpinIndex), etc.
- [ ] No downstream tooling breaks due to renamed/removed columns.

---

## P2 – Nice to Have

### P2-1. Spot-check positions correctness visually
- [ ] For several LINE wins, verify `positions` align with the actual payline path and matchCount.
- [ ] No row/col transposition bugs.

---

### P2-2. Guardrails documented
- [ ] README/spec notes briefly state:
  - single evaluation point
  - strict validation expectations
  - shadow columns meaning

---

## Exit Criteria

✅ You may proceed to **Branch A (Invariant / Regression)** when:
- All **P0** items are checked
- Any failing P1/P2 items are recorded as follow-up tasks (not silently ignored)

---

## Notes / Common Failure Patterns

- **Failure:** `Validation mismatch` during FREE  
  **Cause:** FREE uses placeholder grid or does not resolve a grid.  
  **Fix:** Enable FREE resolution (Route A) using BASE fallback while preserving determinism.

- **Failure:** Visual breaks wins  
  **Cause:** protectedCells derived incorrectly (row/col mismatch or guessing)  
  **Fix:** Ensure priority `winEvents.positions` and correct coordinate convention.

