# v1.4.patch Checklist 實作狀態

## ✅ 已完成項目

### 0) Scope & Non‑Negotiable Contracts
- ✅ 僅允許修改 `logic/visualConstraint.js` 及其 helper
- ✅ 不允許改動 Math Core / Outcome / RTP / RNG 序列
- ✅ Visual Layer 可開關（`visualConfig.enabled`）
- ✅ 可回退機制（guard fail → rollback → retry → fallback baseGrid）
- ✅ 可重現（使用 derived visual seed）

### 1) Config & Telemetry
- ⚠️ **部分完成**：
  - ✅ `visualConfig.enabled`（已實作）
  - ✅ `visualConfig.maxRetries`（已實作）
  - ✅ `visualConfig.safeFiller`（已實作）
  - ⚠️ `visualConfig.nearMiss`（需要擴充）
  - ⚠️ `visualConfig.tease`（需要擴充）
  - ⚠️ `visualConfig.seedStrategy`（需要新增）
  - ⚠️ `visualConfig.patchVersion`（需要新增）
  - ❌ Telemetry 欄位（需要新增到 CSV/reporter）

### 2) Near Miss
- ✅ 觸發條件（`outcome.type === "LOSS" && outcome.id.includes("NEAR_MISS")`）
- ✅ 多線隨機（不寫死在 payline[0], payline[1]）
- ✅ MVP 策略：N-1 + Break（符號一致）
- ⚠️ 支援 `multiLineCountRange`（需要改進）
- ✅ Guard（accidental-win scan + retry/fallback）

### 3) Tease
- ✅ 觸發條件（`outcome.id.includes("SMALL_WIN")`）
- ✅ 三條鐵律（WinLine protection, Anti-Extend, Anti-New-Win）
- ✅ MVP 策略（非 WinLine 優先，1~2 條 tease payline）
- ⚠️ 支援 `targetOutcomeIds`（需要改進）
- ✅ Guard（anti-extend + accidental-win scan）

### 4) RNG / Reproducibility
- ✅ Derived Seed 規範（`hash(mathSeed, spinIndex, outcome.id, "VISUAL", patchVersion)`）
- ✅ Determinism（相同 context → 相同結果）
- ✅ Visual on/off 不影響 Math outcome sequence

### 5) Acceptance Checklist
- ✅ Near Miss 觸發（非 dead code）
- ✅ Near Miss payline 選擇不固定
- ✅ Near Miss 符號一致
- ✅ Tease 不修改 winLine 的 matchCount
- ✅ Tease 不延長 winLine
- ✅ 不新增 accidental win
- ⚠️ Telemetry 可回放（需要新增）

## ⚠️ 待完成項目

### Phase A — Config & Telemetry
1. **擴充 visualConfig**（向後相容 + defaults）：
   ```javascript
   visualConfig: {
     enabled: true,
     maxRetries: 10,
     safeFiller: 'L1',
     seedStrategy: 'DERIVED',
     patchVersion: 'v1.4.patch',
     nearMiss: {
       enabled: true,
       multiLineCountRange: [1, 2]
     },
     tease: {
       enabled: true,
       targetOutcomeIds: ['SMALL_WIN', 'FREE_SMALL_WIN']
     }
   }
   ```

2. **新增 Telemetry 欄位到 CSV/reporter**：
   - `visualApplied: boolean`
   - `visualType: "NONE" | "NEAR_MISS" | "TEASE"`
   - `visualPaylinesChosen: string`（例如 `"2"` 或 `"2,7"`）
   - `visualGuardFailReason: string | null`
   - `visualAttemptsUsed: number`
   - `visualSeed: string`

3. **改進 applyConstraints 返回 telemetry**：
   - 目前只返回 grid，需要返回 `{ grid, telemetry }`

### Phase B — Near Miss 改進
1. **支援 multiLineCountRange**：
   - 目前只選擇 1 條 payline
   - 需要支援選擇 1~2 條（根據配置）

### Phase C — Tease 改進
1. **支援 targetOutcomeIds**：
   - 目前只檢查 `outcome.id.includes("SMALL_WIN")`
   - 需要支援配置中的 `targetOutcomeIds` 列表

### Phase D — Optional Phase 3
- ⏳ Front-Block + Back-Load（可選，目前未實作）

## 建議實作順序

1. **優先級 1（必須）**：
   - 擴充 visualConfig（向後相容）
   - 改進 applyConstraints 返回 telemetry
   - 更新 resolver.js 收集 telemetry
   - 更新 CSV/reporter 輸出 telemetry

2. **優先級 2（重要）**：
   - 改進 Near Miss 支援 multiLineCountRange
   - 改進 Tease 支援 targetOutcomeIds

3. **優先級 3（可選）**：
   - Phase 3 Front-Block + Back-Load

## 當前實作狀態總結

**核心功能已完成**：
- ✅ Near Miss 基本功能
- ✅ Tease 基本功能
- ✅ 安全性驗證
- ✅ RNG 隔離與 determinism

**需要改進**：
- ⚠️ Config 擴充（向後相容）
- ⚠️ Telemetry 支援
- ⚠️ 配置選項支援（multiLineCountRange, targetOutcomeIds）

**程式可正常執行**，但缺少完整的配置和 telemetry 支援。

