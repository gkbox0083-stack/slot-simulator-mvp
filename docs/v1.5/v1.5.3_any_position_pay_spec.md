# v1.5.3 Any-Position Pay Specification

## 版本資訊
- **版本**: v1.5.3
- **功能**: Any-Position Pay (Minimal Safe Subset)
- **日期**: 2024

---

## 1. Scope（範圍與限制）

### 1.1 功能範圍
- ✅ **ANY_POSITION** win condition：符號數量在 grid 上任意位置達到目標數量
- ✅ 專用符號：`A1`（僅用於 ANY_POSITION，不得用於 LINE pay）
- ✅ Trigger behavior：ANY_POSITION outcome → grid 包含 EXACTLY K 個 A1
- ✅ Non-trigger behavior：所有其他 outcomes → grid 包含 EXACTLY 0 個 A1（Anti-trigger guard）
- ✅ Exclusivity rule：A1 不得出現在任何 LINE pay rules 中

### 1.2 明確禁止事項（v1.5.3 不實作）
- ❌ **Multi-win**: LINE + ANY_POSITION 同時觸發
- ❌ **Scatter involvement**: 不涉及 Scatter 符號或邏輯
- ❌ **Wild substitution**: Wild 不得替代 A1 進行 ANY_POSITION 計算
- ❌ **Multiple symbols**: 一個 ANY_POSITION win 只能使用單一符號（A1）
- ❌ **Retrigger / New features**: 不引入新的 feature 系統

### 1.3 與既有功能的關係
- v1.5.3 的 Any-Position Layer 是**獨立 layer**，不重構既有 resolver pipeline
- 既有 LINE pay、Scatter、FSM 保持不變
- A1 符號必須在 base grid 生成**之後**套用（類似 Scatter Layer 的覆寫策略）

---

## 2. Truth Source 語義（事件真源 vs 規則真源）

### 2.1 Outcome Truth Source（事件真源）
**定義**: `outcomeTables` 決定「本 spin outcome（含是否為 ANY_POSITION）」是唯一事件真源。

**語義**:
- `outcome.winCondition.type === 'ANY_POSITION'` → **觸發 ANY_POSITION win**
- 所有其他 outcome → **不觸發**

**關鍵規則**:
- Outcome 選擇發生在 **FSM 狀態確定之後**（BASE 抽 BASE table，FREE 抽 FREE table）
- Outcome 一旦選定，**不可修改**（Truth Source 不變）
- A1 count 必須與 outcome 一致（STRICT 驗證）

### 2.2 Config Truth Source（規則真源）
**定義**: `config` 定義「符號定義、目標數量、視覺落地規則」。

**結構**:
```json
{
  "symbols": [
    { "id": "A1", "name": "AnyPos1", "type": "ANY_POSITION" }
  ],
  "outcomeTables": {
    "BASE": {
      "outcomes": [
        {
          "id": "ANY_POS_A1_K",
          "type": "WIN",
          "winCondition": {
            "type": "ANY_POSITION",
            "symbolId": "A1",
            "targetCount": K
          }
        }
      ]
    }
  }
}
```

---

## 3. Any-Position 行為（消歧義策略）

### 3.1 Trigger 情況（outcome.winCondition.type === 'ANY_POSITION'）
**規則**: `a1Count` 必須「剛好 == targetCount」

**執行流程**:
1. Outcome 已選定：`outcome.winCondition.type === 'ANY_POSITION'` 且 `outcome.winCondition.symbolId === 'A1'`
2. Any-Position Layer 目標：在 grid 上放置 **exactly targetCount** 個 A1 符號
3. STRICT 驗證：最終 `a1Count === targetCount`，否則 throw

**放置策略**:
- 使用 `RANDOM_ANYWHERE` 模式（類似 Scatter Layer）
- 覆寫 grid 上的非保護位置（v1.5.3 不保護 line win，因為禁止 multi-win）
- 使用 seeded RNG 選位置覆寫（確保 deterministic）

### 3.2 Non-trigger 情況（任何非 ANY_POSITION outcome）
**規則**: `a1Count` 必須「固定 == 0」（v1.5.3 最保守）

**執行流程**:
1. Outcome 已選定：非 ANY_POSITION 或 ANY_POSITION 但 symbolId 不匹配
2. Any-Position Layer 目標：確保 grid 上 **0 個 A1 符號**
3. STRICT 驗證：最終 `a1Count === 0`，否則 throw

**清理策略**:
- 如果 base grid 已包含 A1 符號，必須清除（覆寫為非 A1）
- 使用 seeded RNG 選替換符號（確保 deterministic）

### 3.3 重試與 Fallback
**重試機制**:
- 有限重試（例如 20 次）
- 每次重試使用不同的 RNG seed（基於 retry count）
- 若重試失敗，允許 fallback（但必須符合 Truth Source）

**Fallback 策略**:
- 優先 Truth Source：觸發與否必須與 a1Count 相容
- 若無法達成目標 a1Count，記錄警告並 fallback 到最接近的合法狀態

---

## 4. Exclusivity Rule（排他性規則）

### 4.1 A1 不得出現在 LINE pay rules
**規則**: A1 符號**不得**出現在任何 LINE pay rule 的 `winCondition.symbolId` 或 `winConfig.symbolId` 中。

**Validator 檢查**:
- 掃描所有 `outcomeTables.BASE.outcomes` 和 `outcomeTables.FREE.outcomes`
- 對於每個 `WIN` 類型的 outcome：
  - 如果 `winCondition.type === 'LINE'` 且 `winCondition.symbolId === 'A1'` → throw error
  - 如果 `winConfig.symbolId === 'A1'` → throw error

**STRICT 模式**:
- 如果 validator 檢測到 A1 出現在 LINE rule 中，必須 throw error（不可僅警告）

---

## 5. WinEvent 結構（v1.5.3）

### 5.1 ANY_POSITION WinEvent
```typescript
{
  eventId: string,              // 例如 "ANY_POS_A1_5"
  ruleType: "ANY_POSITION",     // 規則類型
  winAmount: number,            // 贏分（credit int）
  paidSymbolId: "A1",           // 支付符號 ID
  displaySymbolId: "A1",         // 顯示符號 ID（通常等於 paidSymbolId）
  positions: Array<[row, col]>,  // A1 符號的所有位置
  matchCount: number,            // 實際數量（等於 positions.length）
  metadata?: Object              // 額外元資料
}
```

### 5.2 約束
- `winEvents.length ∈ {0,1}`（單事件模式）
- `positions.length === matchCount === targetCount`（STRICT）
- `positions` 中的每個位置都必須包含 A1 符號

---

## 6. Resolver Any-Position Layer

### 6.1 執行順序
1. Base grid 生成（使用既有 pipeline）
2. Scatter Layer（如果存在，v1.5.2）
3. **Any-Position Layer（v1.5.3 新增）**
4. Visual Constraint Layer（如果啟用）

### 6.2 Any-Position Layer 邏輯
```javascript
_applyAnyPositionLayer(grid, outcome, state, mathSeed, spinIndex, outcomeId) {
  // 判斷是否為 trigger 情況
  const isTrigger = outcome.winCondition?.type === 'ANY_POSITION' 
    && outcome.winCondition?.symbolId === 'A1';
  
  // 目標 a1Count
  const targetCount = isTrigger ? outcome.winCondition.targetCount : 0;
  
  // 派生 any-position RNG（使用 mathSeed, spinIndex, outcomeId）
  const anyPosSeed = RNG.deriveSubSeed('ANY_POSITION', {
    mathSeed: mathSeed || 'default',
    spinIndex: spinIndex || 0,
    outcomeId: outcomeId || outcome.id,
    patchVersion: 'v1.5.3'
  });
  const anyPosRng = new RNG(anyPosSeed);
  
  // 計算當前 a1Count
  const currentCount = countA1(grid);
  
  // 調整 a1Count 以符合目標
  // ... (類似 Scatter Layer 的邏輯)
  
  // STRICT 驗證
  const finalCount = countA1(grid);
  if (finalCount !== targetCount) {
    throw new Error(
      `v1.5.3 STRICT: A1 count mismatch: expected=${targetCount}, actual=${finalCount}, ` +
      `state=${state}, outcome=${outcome.id}, seed=${mathSeed}, spin=${spinIndex}`
    );
  }
}
```

---

## 7. Evaluator Extension

### 7.1 支援 ANY_POSITION Rule
```javascript
evaluate(grid, ruleContext = {}) {
  // 先評估 LINE pay（既有邏輯）
  const lineEvents = this._evaluateLinePay(...);
  
  // v1.5.3: 評估 ANY_POSITION pay
  const anyPosEvents = this._evaluateAnyPositionPay(grid);
  
  // v1.5.3 限制：只返回第一個匹配的事件（單事件模式）
  if (lineEvents.length > 0) {
    return lineEvents.slice(0, 1);
  }
  if (anyPosEvents.length > 0) {
    return anyPosEvents.slice(0, 1);
  }
  
  return [];
}
```

### 7.2 _evaluateAnyPositionPay 實作
```javascript
_evaluateAnyPositionPay(grid) {
  // 計算 A1 數量
  const a1Count = countA1(grid);
  
  // v1.5.3: 簡化策略 - 如果 a1Count >= 3，產生 WinEvent
  // 注意：實際的 targetCount 應該從 outcome 取得，但 evaluator 不應依賴 outcome
  // 因此，evaluator 只負責「檢測」A1 數量，不負責「驗證」是否符合 outcome
  
  if (a1Count >= 3) {  // 最小觸發門檻（可配置）
    return [{
      eventId: `ANY_POS_A1_${a1Count}`,
      ruleType: 'ANY_POSITION',
      paidSymbolId: 'A1',
      displaySymbolId: 'A1',
      positions: collectA1Positions(grid),
      matchCount: a1Count
    }];
  }
  
  return [];
}
```

**注意**: Evaluator 不應依賴 outcome，只負責檢測 grid 上的 A1 數量。`winAmount` 由 `simulate.js` 根據 `outcome.payoutMultiplier * bet` 設定。

---

## 8. Telemetry 結構

### 8.1 Spin Result 結構
```typescript
{
  spinIndex: number,
  outcome: Outcome,
  grid: Grid,
  winEvents: WinEvent[],
  anyPosition: {
    symbolId: "A1",
    targetCount: number,      // 目標數量（來自 outcome）
    actualCount: number,      // 實際數量（grid 上的 A1 數量）
    guardApplied: boolean,    // 是否應用 guard（清理/放置）
    attemptsUsed: number,     // 重試次數
    fallbackUsed: boolean     // 是否使用 fallback
  }
}
```

### 8.2 CSV/Reporter 欄位
新增欄位：
- `winConditionType`: "LINE" | "ANY_POSITION" | null
- `anyPosSymbolId`: "A1" | ""
- `anyPosTargetCount`: number | ""
- `anyPosActualCount`: number

---

## 9. Acceptance Checklist

### 9.1 機械驗收腳本要求
必須新增：`logic/tests/v1.5.3/acceptance_any_position.test.js`

**必驗項目**:
1. ✅ 同 seed 兩次 run：outcome/state/a1Count 序列完全一致（determinism）
2. ✅ evaluator 每 spin 呼叫次數 == 1（single evaluation point）
3. ✅ STRICT_MODE mismatch == 0（所有 spin 通過 strict validation）
4. ✅ Trigger 時 `a1Count === targetCount`（STRICT）
5. ✅ Non-trigger 時 `a1Count === 0`（STRICT）
6. ✅ A1 不出現在任何 LINE pay rule 中（STRICT）
7. ✅ 每個 spin 最多 1 個 WinEvent（單事件模式）
8. ✅ 沒有 spin 同時觸發 LINE 和 ANY_POSITION（禁止 multi-win）

### 9.2 P0 Gate 指標
執行命令：
```bash
node logic/cli.js -n 2000 --seed 999 --csv v153_run1.csv
node logic/cli.js -n 2000 --seed 999 --csv v153_run2.csv
```

**輸出指標**:
- `mismatchCount`: 必須 == 0
- `v153_run1.csv === v153_run2.csv`: 必須完全一致（determinism）
- `anyPosActualCount` 分布：
  - Non-trigger: 幾乎全為 0
  - Trigger: 全部 == targetCount
- `winConditionType` 分布：LINE vs ANY_POSITION 互斥

**失敗條件**:
- STRICT_MODE 出現 mismatch → 立即停止
- Determinism 測試失敗 → 立即停止
- Evaluator 呼叫次數 != 1 → 立即停止
- A1 出現在 LINE rule → 立即停止

---

## 10. 實作順序（Step-by-Step）

1. **GATE 1**: 建立規範真源文件（本文件）✅
2. **GATE 2**: Config / Schema 更新
3. **GATE 3**: Outcome Table 更新
4. **GATE 4**: Resolver Any-Position Layer
5. **GATE 5**: Evaluator Extension
6. **GATE 6**: CSV / Reporting 更新
7. **GATE 7**: Acceptance 測試

---

## 11. 關鍵設計決策

### 11.1 Any-Position Layer 獨立性
- Any-Position Layer 是**獨立 layer**，不重構既有 resolver pipeline
- 在 base grid 生成後套用（覆寫策略）
- 使用 seeded RNG 確保 deterministic

### 11.2 Truth Source 優先
- Outcome 決定觸發與否（Truth Source）
- A1 count 必須與 outcome 一致（STRICT 驗證）
- 若無法達成目標，優先 fallback 而非修改 outcome

### 11.3 保守策略（v1.5.3）
- Non-trigger 時 a1Count 固定 == 0（最保守）
- 禁止 multi-win（避免複雜性）
- 禁止 A1 出現在 LINE rules（確保排他性）

### 11.4 專用符號策略
- A1 符號**僅**用於 ANY_POSITION
- A1 不得出現在 LINE pay rules（validator 強制檢查）
- Base generator 不應生成 A1（fillerWeights 設為 0）

---

## 12. 參考文件
- Branch A Invariant Spec: `docs/v1.5/spec/BranchA_Invariant_Spec.md`
- v1.5.0 Core Contracts: `docs/v1.5/interfaces/v1.5_core_contracts.md`
- v1.5.2 Scatter + FSM Spec: `docs/v1.5/v1.5.2_scatter_fsm_spec.md`

