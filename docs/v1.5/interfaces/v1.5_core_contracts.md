# v1.5 Core Contracts（Interfaces / Semantics）

> 這份文件是「型別/語義契約」，用來防止 Cursor/工程師自作主張改結構。
> v1.5.1 的變更：加入 Wild 的 paid vs observed 語義，以及「可注入 match predicate」機制。

---

## 1. Coordinate Contract

- `positions` 為 **[row, col]**（row-major）
- row/col 與 paylines 的座標系必須一致

---

## 2. Symbol Contract

### 2.1 Symbol Definition
- `id`: string（例：H1, L1, W）
- `type`: enum-like string（例：HIGH / MID / LOW / WILD / SCATTER / BONUS / FEATURE）

### 2.2 Wild Identification
- Wild 以 **config 中 symbol.type == "WILD"** 定義
- 禁止在 evaluator 內以「特殊字元」或「硬編碼 id」當作唯一判斷來源（ruleCtx 才能決定行為）

---

## 3. Pay Rule / Rule Context Contract

### 3.1 wildConfig（v1.5.1）
- `wildSymbolId: string`
- `substitutableTypes: string[]`

### 3.2 ruleCtx（Evaluator 可讀取的上下文）
最小包含：
- `symbolsById`（或可查到 symbol.type 的等價結構）
- `wildConfig`（可選；未提供代表無 Wild 行為）

### 3.3 match predicate（v1.5.1 統一簽名）

v1.5.1 統一使用以下語義簽名（避免文件間不一致）：

- `isMatch(cellSymbolId: string, targetSymbolId: string, ruleCtx) -> boolean`

**推薦實作方式（簡化且安全）：Evaluator 內部私有方法 + 讀取 ruleCtx**
- ✅ predicate 實作在 evaluator 內部（例如 `_isMatch`），以便保持 loops 結構不變（只替換相等判斷為 function call）。
- ✅ Wild 的替代規則必須**從 ruleCtx.wildConfig 讀取**（資料驅動）。
- ❌ 禁止在 evaluator 內硬編碼 Wild：
  - 禁止 `if (symbol.type === 'WILD') ...`
  - 禁止 `if (cellSymbolId === 'W') ...`（固定 id）

**Default Behavior（Robustness）**
- 若 `ruleCtx.wildConfig` 不存在：`isMatch` 必須退化為 `cellSymbolId === targetSymbolId`。

---

## 4. WinEvent Contract（v1.5.1）
 WinEvent Contract（v1.5.1）

### 4.1 Single WinEvent Rule（Series rule）
- v1.5.x（含 v1.5.1）每 spin 仍維持 **0~1 WinEvent**
- 不允許 multi-win（直到對應版本決策開放）

### 4.2 Required Fields
- `winAmount: number`（integer credits）
- `positions: Array<[row:number, col:number]>`（LINE event 必有）
- `paidSymbolId: string`（此事件以誰計價）
- `observedSymbolIds: string[]`（與 positions 同長度，記錄 grid 原始 symbolId）

> `paidSymbolId` 與 `observedSymbolIds` 允許不同（Wild 參與時必然發生）。

### 4.3 Optional / Existing Fields
- 若既有系統已有 `paylineId`、`patternId`、`winRuleId` 等，可保留不動。
- 但不得移除上述 required fields。

---

## 5. Outcome vs Evaluator Truth Source（Reminder）

- Outcome 定義 expected payout
- Evaluator 是 deterministic verifier + explainer
- STRICT_MODE 下 expectedWin 必須等於 sum(winEvents.winAmount)
