# v1.4.patch – Phase A / B / C (Cursor Ready Prompt)

> **Scope**: This task finalizes v1.4.patch by completing **Config, Telemetry, Seed Spec unification, and forward-compat guards**.  
> **Hard rule**: Do NOT modify Math Core logic, RNG consumption, Outcome selection, or winAmount.

---

## 0. Non‑Negotiable Architecture Contract

- **simulate.js (Math Core)**
  - ❌ Must NOT be changed
  - ❌ Must NOT consume Visual RNG

- **resolver.js (Math / Pattern)**
  - ✅ May pass-through telemetry only
  - ❌ Must NOT branch logic based on telemetry

- **visualConstraint.js (Visual Layer)**
  - ✅ All changes live here
  - ❌ Must NOT alter outcome, winAmount, matchCount, paylines

---

## Phase A — Config & Telemetry (MUST‑HAVE)

### A1. Config Schema Extension (Backward Compatible)

**File(s):**
- `design.json`
- `config/visualConfig.ts` (or equivalent loader)

**Required structure (defaults must be safe):**
```json
visualConfig: {
  enabled: true,
  seedStrategy: "DERIVED",
  patchVersion: "v1.4.patch",

  nearMiss: {
    enabled: true,
    multiLineCountRange: [1, 2]
  },

  tease: {
    enabled: true,
    targetOutcomeIds: ["SMALL_WIN"]
  }
}
```

Rules:
- Missing config → fallback to defaults
- No hard‑coded SMALL_WIN checks in logic

---

### A2. Telemetry Contract

**File:** `visualConstraint.js`

#### Function Signature (MANDATORY)
```ts
applyConstraints(
  grid,
  outcome,
  context
): { grid, telemetry }
```

#### Telemetry Schema
```ts
telemetry = {
  visualRequestedType: "NEAR_MISS" | "TEASE" | "NONE",
  visualAppliedType: "NEAR_MISS" | "TEASE" | "NONE",
  visualApplied: boolean,

  visualPaylinesChosen: number[],
  visualAttemptsUsed: number,
  visualGuardFailReason?: string,

  visualSeed: string
}
```

Notes:
- `visualRequestedType` ≠ `visualAppliedType` (guard rollback must be visible)
- Telemetry is **diagnostic only** — must not influence decisions

---

### A3. Telemetry Propagation

**Files:**
- `resolver.js`
- `reporter.js`
- `cli.js` / CSV exporter

Rules:
- Resolver: pass telemetry through only
- Reporter / CSV: output telemetry fields verbatim

**Required CSV Columns:**
- `visualRequestedType`
- `visualAppliedType`
- `visualApplied`
- `visualPaylinesChosen`
- `visualAttemptsUsed`
- `visualGuardFailReason`
- `visualSeed`

---

## Phase B — Forward‑Compatibility Guard (v1.5 Safety)

### B1. Forbidden Symbols in Visual Layer

**File:** `visualConstraint.js`

Introduce:
```ts
const forbiddenSymbolsInVisual = ["WILD", "SCATTER", "BONUS"];
```

Rules:
- Near Miss / Tease filler symbols must NEVER include forbidden symbols
- Guard must rollback if forbidden symbol is accidentally introduced

Purpose:
- Prevent future Wild / Scatter logic from breaking v1.4 visuals

---

## Phase C — Derived Seed Unification (Reproducibility)

### C1. Single Source of Truth

**File:** `visualRng.ts` (or equivalent helper)

**Derived seed formula (MANDATORY):**
```ts
hash(
  mathSeed,
  spinIndex,
  outcome.id,
  "VISUAL",
  patchVersion // must be "v1.4.patch"
)
```

Rules:
- Remove legacy string concatenations like `":visual"`
- patchVersion must be included to avoid future collisions

---

## Acceptance Checklist (REQUIRED)

### Functional
- [ ] Visual on/off produces identical Math outcomes
- [ ] Near Miss never produces payout
- [ ] Tease never changes matchCount or adds winlines
- [ ] Guard rollback visible in telemetry

### Reproducibility
- [ ] Same seed + spinIndex → identical visual grid
- [ ] Changing patchVersion changes visual only (math unchanged)

### Observability
- [ ] CSV contains all telemetry fields
- [ ] visualRequested vs visualApplied distinguishable

### Forward Safety
- [ ] No Wild / Scatter / Bonus symbols appear due to visuals

---

## Stop Conditions (IMPORTANT)

If ANY of the following are unclear:
- Config missing / ambiguous
- Telemetry propagation uncertain
- Guard logic conflicts

**STOP and ask. Do NOT guess.**

---

## Definition of Done

v1.4.patch is considered **complete** only when:
- Phase A, B, C all pass
- Telemetry enables full diagnosis of every visual decision
- System is safe to proceed into v1.5

