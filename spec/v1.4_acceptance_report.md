# v1.4 Acceptance Report — Pattern Auto Generation

## 驗收檢查結果

### A. Math Sequence Invariance (Critical) ⚠️ 需要實際測試

**狀態**: 需要執行對比測試

**檢查項目**:
- [ ] 固定 seed 下，v1.3 vs v1.4 outcomeId 序列是否相同（spin-by-spin）
- [ ] 固定 seed 下，Total Win Amount 是否完全相同
- [ ] 固定 seed 下，Gap 統計（avg/median/max）是否相同
- [ ] Visual Layer 開關是否不影響 outcome 序列

**實作檢查**:
- ✅ PatternGenerator 使用獨立的 Pattern RNG（不消耗 Math RNG）
- ✅ `_derivePatternSeed()` 使用 deterministic hash（不依賴 Math RNG）
- ✅ `simulate.js` 中 Math RNG 僅用於 outcome selection，不參與 pattern generation

**建議**: 執行對比測試腳本驗證

---

### B. Pattern Auto Generation Correctness (Critical) ✅

#### LINE winCondition
- ✅ **Anchors count == matchCount**: `_generateLineAnchors()` 第 132 行，只生成 `matchCount` 個 anchors
- ✅ **All anchors lie on the same payline**: 第 128 行選擇單一 payline，第 132-139 行在該 payline 上生成 anchors
- ✅ **Anchor symbolId == winCondition.symbolId**: 第 137 行使用 `symbolId`
- ✅ **Only minimal anchors**: 只生成 `matchCount` 個 anchors，不生成完整 grid

#### SCATTER winCondition
- ✅ **Anchors count == minCount**: `_generateScatterAnchors()` 第 184 行，選擇 `minCount` 個位置
- ✅ **Anchor positions are unique**: 第 186 行使用 `splice` 確保不重複
- ✅ **Anchor symbolId == scatter symbolId**: 第 193 行使用 `symbolId`
- ✅ **Light-weight validation**: `_checkAnchorsOnlyAccidentalWin()` 僅檢查 anchors 本身，不掃描完整 grid

---

### C. Pattern RNG Isolation & Determinism (Critical) ✅

- ✅ **Pattern Generator 使用 derived-seed Pattern RNG**: `_derivePatternSeed()` 第 71-85 行
- ✅ **Pattern RNG 不消耗 Math RNG**: PatternGenerator 使用獨立的 `localRng`（第 51 行）
- ✅ **相同 context → 相同 anchors**: `_derivePatternSeed()` 使用 deterministic hash
- ✅ **不同 spinIndex → 不同 anchors**: seed 包含 `spinIndex`（第 73 行）
- ✅ **不使用非確定性來源**: 已檢查，無 `Date.now()`, `Math.random()` 等

**實作細節**:
```javascript
// logic/patternGenerator.js:71-85
_derivePatternSeed(context) {
  const seedString = `${context.mathSeed}:${context.spinIndex}:${context.outcomeId}:PATTERN`;
  // 使用 deterministic hash
  let hash = 0;
  for (let i = 0; i < seedString.length; i++) {
    const char = seedString.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // Convert to 32bit integer
  }
  return Math.abs(hash) || 1;
}
```

---

### D. Backward Compatibility (Critical) ✅

- ✅ **winCondition → GENERATED**: `resolver.js` 第 87-115 行
- ✅ **legacy pattern → LEGACY**: `resolver.js` 第 116-118 行
- ✅ **LOSS/FEATURE 不需要 pattern**: `resolver.js` 第 123-125 行，`patternSource = 'NONE'`
- ✅ **winCondition + legacy → warning**: `resolver.js` 第 92-94 行
- ✅ **Legacy behavior 不變**: `_resolveWin()` 和 `_resolveLoss()` 保持原有邏輯

**實作細節**:
```javascript
// logic/resolver.js:85-126
if (outcome.type === 'WIN') {
  if (outcome.winCondition) {
    patternSource = 'GENERATED';
    // 警告共存
    if (outcome.pattern || outcome.patterns) {
      console.warn(...);
    }
  } else if (outcome.pattern || outcome.patterns) {
    patternSource = 'LEGACY';
  } else {
    throw new Error(...);  // WIN 類型缺定義
  }
} else {
  patternSource = 'NONE';  // LOSS/FEATURE 不需要 pattern
}
```

---

### E. Validator Rules (Critical) ✅

- ✅ **WIN outcomes 必須定義 winCondition 或 legacy pattern**: `validator.js` 第 150-153 行
- ✅ **LOSS/FEATURE outcomes 不需要 pattern**: `validator.js` 第 155 行註解說明
- ✅ **LINE winCondition 驗證**: `validator.js` 第 164-186 行（symbolId, matchCount）
- ✅ **SCATTER winCondition 驗證**: `validator.js` 第 187-209 行（symbolId, minCount）
- ✅ **winCondition + legacy → warning**: `validator.js` 第 144-146 行
- ✅ **WIN 都沒有 → error**: `validator.js` 第 151-153 行

**實作細節**:
```javascript
// logic/validator.js:148-155
// 必修補點 1：只對 WIN 類型要求 pattern 定義
// LOSS/FEATURE 類型不需要 pattern（由 resolver 自動生成）
if (outcome.type === 'WIN') {
  if (!hasWinCondition && !hasLegacyPattern) {
    result.addError(...);
  }
}
// LOSS/FEATURE 類型不需要 pattern，不檢查
```

---

### F. Resolver Behavior (Important) ✅

- ✅ **resolve(outcome, context) 接收 context**: `resolver.js` 第 79 行，接收 `{spinIndex, mathSeed, outcomeId}`
- ✅ **_resolveFromAnchors() 正確建立 grid**: `resolver.js` 第 183-231 行
- ✅ **GENERATED/LEGACY/NONE 路徑明確**: `resolver.js` 第 143-154 行

**實作細節**:
```javascript
// logic/resolver.js:143-154
if (patternSource === 'GENERATED') {
  patternResult = this._resolveFromAnchors(outcome, generatedInfo);
} else if (patternSource === 'LEGACY') {
  patternResult = this._resolveWin(outcome);
} else if (patternSource === 'NONE') {
  patternResult = this._resolveLoss(outcome);
}
```

---

### G. Reporter & CSV Output (Important) ✅

#### CSV 欄位
- ✅ **patternSource**: `cli.js` 第 220, 232 行
- ✅ **winConditionType**: `cli.js` 第 220, 233 行
- ✅ **generatedWinLine**: `cli.js` 第 220, 234 行
- ✅ **anchorsCount**: `cli.js` 第 220, 235 行

#### Console Reporter
- ✅ **顯示 patternSource**: `reporter.js` 第 246-259 行

#### 資料來源
- ✅ **simulate.js 正確填充 spinLog**: `simulate.js` 第 395-399 行

**實作細節**:
```javascript
// logic/simulate.js:395-399
spinLog.push({
  // ... 其他欄位 ...
  patternSource: patternResult.patternSource || 'NONE',
  winConditionType: patternResult.winConditionType || null,
  generatedWinLine: patternResult.winLine !== null ? patternResult.winLine : null,
  anchorsCount: patternResult.anchorsCount || 0
});
```

---

## 總結

### ✅ 已完成的項目（6/7 大項）

1. ✅ **B. Pattern Auto Generation Correctness** - 完全符合
2. ✅ **C. Pattern RNG Isolation & Determinism** - 完全符合
3. ✅ **D. Backward Compatibility** - 完全符合
4. ✅ **E. Validator Rules** - 完全符合
5. ✅ **F. Resolver Behavior** - 完全符合
6. ✅ **G. Reporter & CSV Output** - 完全符合

### ⚠️ 需要測試的項目（1/7 大項）

1. ⚠️ **A. Math Sequence Invariance** - 需要執行實際對比測試

### 建議下一步

1. **執行對比測試**: 建立測試腳本，使用相同 seed 執行 v1.3 和 v1.4，比較 outcomeId 序列、Total Win、Gap 統計
2. **驗證 Visual Layer 隔離**: 測試 `--no-visual` 參數是否不影響 outcome 序列
3. **回歸測試**: 確保所有現有功能正常運作

---

## 驗收結論

**v1.4 實作符合驗收標準**，但需要執行實際對比測試以驗證 **A. Math Sequence Invariance**。

所有程式碼層面的檢查都已通過，Pattern Auto Generation 功能已正確實作並符合規格。

